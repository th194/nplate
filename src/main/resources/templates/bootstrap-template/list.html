<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="bootstrap-template/layout/basic">
<th:block layout:fragment="title">
    <title>게시글 목록</title>
</th:block>

<th:block layout:fragment="main-content">
        <div class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center infinite" id="post-container"></div>
        <ul class="pagination"></ul>
</th:block>



<th:block layout:fragment="script">
    <script th:inline="javascript">
        /*<![CDATA[*/

        /* 게시글 리스트 조회 S */
        window.onload = () => {
            console.log("게시글 리스트 조회====================");
            setQueryStringParams();
            findAllPost();
        }

        function findAllPost() {
            var list = [[${response.list}]];
            if (!list.length) {
                document.getElementById('post-container').innerHTML = '<div>검색 결과가 없습니다.</div>';
                return false;
            }
            var params = [[${params}]];
            var pagination = [[${response.pagination}]];

            drawList(list);
            drawPage(pagination, params);
        }

        // 조회 목록
        function drawList(list) {
            var likes = [[${likeNumbers}]]; // 좋아요 누른 글 번호

            var posting = '';
            list.forEach(obj => {
                console.log('오브젝트============');
                console.log(obj);

                posting += `<div class="col mb-5 list">
                    <div class="card h-100">
                    <img class="card-img-top" src="${obj.bbscttImage}" alt="..."
                    onError="javascript:this.src='https://dummyimage.com/450x450/dee2e6/6c757d.jpg'"/>`;

                // 좋아요 버튼
                posting += `<span class="d-flex text-danger mb-2 like-btn" id="like_${obj.bbscttNo}" style="position: absolute; top: 0.5rem; right: 0.5rem">`;

                if (likes.includes(obj.bbscttNo)) {
                    posting += `<i class="bi bi-heart-fill"></i>`;
                } else {
                    posting += `<i class="bi bi-heart"></i>`;
                }

                posting += `</span>
                    <div class="card-body">
                    <div class="text-center">
                    <a href="javascript:void(0)" onclick="goViewPage(${obj.bbscttNo})">
                    <h6 class="fw-bolder">
                    ${obj.bbscttSj}
                    </h6>
                    </a>
                `;

                // 별점
                posting += '<div class="d-flex justify-content-center small text-warning mb-2">';
                for (var i = 0; i < obj.bbscttGrade; i++) {
                    posting += '<div class="bi-star-fill"></div>';
                }

                for (var j = 0; j < 5 - obj.bbscttGrade; j++) {
                    posting += '<div class="bi-star"></div>';
                }
                posting += '</div>';


                // 해시태그(3개까지만 보이게 처리) - 해시태그 비어있을경우 처리 추가
                if (obj.bbscttHashtag != null && obj.bbscttHashtag != '') {
                    var tag = obj.bbscttHashtag.split(',');
                    console.log('해시태그');
                    console.log(tag);

                    posting += '<div class="text-xs">';
                    var showSize = tag.length > 3? 3 : tag.length;
                    for (var k = 0; k < showSize; k++) {
                        posting += '<span class="text-primary">#' + tag[k] +' </span>';
                    }
                    posting += '</div>';
                }


                posting +=
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
            });

            document.getElementById('post-container').innerHTML = posting;

            // 좋아요 클릭 이벤트 추가
            var likeBtns = document.querySelectorAll('.like-btn');
            likeBtns.forEach( (btn) => {
                btn.onclick = likePost;
            });
        }

        // 페이지 조회 목록
        function drawPage(pagination, params) {
            if (!pagination || !params) {
                document.querySelector('.pagination').innerHTML = '';
                return false;
            }

            var html = '';

            if (pagination.existNextPage) {
                html += `
                <li class="paginate_button page-item">
                    <a href="javascript:movePage(${pagination.endPage + 1})" aria-controls="dataTable" class="page-link next" aria-label="Next">                    </a>
                </li>
                `;
            }

            document.querySelector('.pagination').innerHTML = html;
        }

        /* 게시글 리스트 조회 E */


        /* 좋아요 처리 S */
        function likePost() {
            var testId = [[${memberInfo.id}]]; // 로그인 멤버아이디
            var likeId = $(this).attr('id'); // 좋아요버튼 아이디
            var index = + likeId.substring(likeId.indexOf('_')+1); // 게시물아이디(index)
            var $heart = $(this).find('i'); // 하트 아이콘

            if ( $heart.hasClass('bi-heart-fill') ) { // 이걸로 해도 되고.... 글번호 포함하고 있는지 여부로 해도되고...
                // 좋아요 취소 ajax
                $.ajax({
                    type: "get",
                    dataType: "text",
                    async: false,
                    url: "/board/deleteLike",
                    data: { id: testId, idx: index },
                    success: function (data) {
                        if (data === 'success') {
                            alert('좋아요 취소 성공');
                            $heart.removeClass('bi-heart-fill');
                            $heart.addClass('bi-heart');

                        } else {
                            alert('좋아요 취소 실패');
                        }
                    },
                    error: function () {
                        alert('좋아요 취소 실패');
                    }
                });


            } else {
                // 좋아요 추가 ajax
                $.ajax({
                    type: "get",
                    dataType: "text",
                    async: false,
                    url: "/board/addLike",
                    data: { id: testId, idx: index },
                    success: function (data) {
                        if (data === 'success') {
                            alert('좋아요 추가 성공');
                            $heart.removeClass('bi-heart');
                            $heart.addClass('bi-heart-fill');

                        } else {
                            alert('좋아요 추가 실패');
                        }
                    },
                    error: function () {
                        alert('좋아요 추가 실패');
                    }
                });
            }
        }
        /* 좋아요 처리 E */


        /* 페이지 이동 S */
        function movePage(page) {
            var form = document.getElementById('searchForm');
            var queryParams = {
                page: (page) ? page : 1,
                recordSize : 10,
                pageSize : 10,
                keyword : form.keyword.value,
                searchType : form.searchType.value
            }
            location.href = location.pathname + '?' + new URLSearchParams(queryParams).toString();
        }
        /* 페이지 이동 E */

        /* 게시글 상세페이지 이동 */
        function goViewPage(idx) {
            var queryString = (location.search) ? location.search + `&idx=${idx}` : `?idx=${idx}`;
            location.href = '/board/view.do' + queryString;
        }
        /* 게시글 상세페이지 이동 */

        /* 인피니트 스크롤 (무한 스크롤) S */

        // infiniteScroll({
        //     container: "#post-container",
        //     item : ".item",
        //     next : ".next",
        //     nextCallback: function() {
        //         console.log('다음페이지 이동했습니다.');
        //     }
        // });


        function YesScroll () {
            const pagination = document.querySelector('.paginaiton');
            const fullContent = document.querySelector('.infinite');
            const screenHeight = screen.height;
            let oneTime = false;
            document.addEventListener('scroll',OnScroll,{passive:true})
            function OnScroll () {
                const fullHeight = fullContent.clientHeight;
                const scrollPosition = pageYOffset;
                if (fullHeight-screenHeight/2 <= scrollPosition && !oneTime) {
                    oneTime = true;
                    madeBox();
                }
            }
            function madeBox() {
                const list = document.createElement('div');
                const box = list.cloneNode('false');
                box.className="box";

                for (var i=0; i<5; i++){
                    list.appendChild(box.cloneNode('true'));
                }
                list.className = "list";
                fullContent.appendChild(list);
                oneTime = false;
            }
        }
        YesScroll()

        /* 인피니트 스크롤 (무한 스크롤) E */


        /* 게시글 리스트 조회 S */

        // 쿼리스트링 파라미터 세팅
        function setQueryStringParams() {
            // location 객체의 search를 이용해서 쿼리 스트링 파라미터를 조회할 수 있다.
            if (!location.search) {
                return false;
            }

            var form = document.getElementById('searchForm');

            new URLSearchParams(location.search).forEach((value, key) => {
                if (form[key]) {
                    form[key].value = value;
                }
            });

            document.getElementById('keyword').value = form.keyword.value;
        }
        /* 게시글 리스트 조회 E */
    </script>

</th:block>
</html>