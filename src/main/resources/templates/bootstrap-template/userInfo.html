<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="bootstrap-template/layout/basic">
<th:block layout:fragment="title">
    <title>유저 페이지</title>
</th:block>

<th:block layout:fragment="main-content">

    <form class="form-horizontal" th:object="${userInfo}">

        <div>
            <div class="card mb-4 py-3 border-bottom-secondary">
                <div class="card-body">
                    <div class="row justify-content-center">
                        <div class="col-md-auto">
                            <img th:src=" '/member/info/profile?id=' + ${userInfo.id}" th:width="100px" th:height="100px" class="img-fluid"
                                style="border-radius: 20%;"/>
                        </div>
                        <div class="col col-md-8">
                            <div>
                                <div class="dropdown no-arrow">
                                    <a class="dropdown-toggle" href="#" id="userDropdown1" role="button"
                                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="text-dark" th:text="${userInfo.nickName}"></span>
                                    </a>
                                    <span th:text="'@'+ ${userInfo.id}"></span>
                                    <div class="dropdown-menu" aria-labelledby="userDropdown1">
                                        <a class="dropdown-item" href="#">
                                            <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                                            팔로잉
                                        </a>
                                        <a class="dropdown-item" href="#">
                                            <i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
                                            메뉴
                                        </a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="#">
                                            <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                            메뉴
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs text-primary" style="margin-top: 1rem">
                                <p>#최근해시태그 #해시태그 #해시태그 #해시태그 #해시태그 #해시태그</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </form>

    <div class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center" id="post-container">

    </div>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        /*<![CDATA[*/

        /* 무한 스크롤 위한 페이지 작업 S */
        var page = 1;

        $(function() {
            console.log('페이지======');
            drawList(page);
            page++;
        });
        $(window).scroll(function() {
            console.log('스크롤페이지======');
            if ($(window).scrollTop() >= $(document).height() - $(window).height()) { // 스크롤 감지
                drawList(page);
                page++;
            }
        });
        /* 무한 스크롤 위한 페이지 작업 E */


        /* 게시글 리스트 조회 S */
        window.onload = () => {
            console.log("게시글 리스트 조회====================");
            findAllPost();
        }

        function findAllPost() {
            var response = [[${response}]];
            if (!response.list.length) {
                document.getElementById('post-container').innerHTML = '<div>게시물이 없습니다.</div>';
                return false;
            }
        }

        // 조회 목록
        function drawList(list) {
            var likes = [[${likeNumbers}]]; // 좋아요 누른 글 번호
            var userInfo = [[${userInfo}]];

            var post = {
                page : page,
                memberId: userInfo.id
            }

            $.ajax({
                type : 'POST',
                dataType : 'json',
                data : post,
                url : '/board/scrollList.do',
                success : function(result) {

                    var list = result.response.list;                // 목록
                    var pagination = result.response.pagination;    // 페이지네이션 정보
                    var html = '';

                    if (pagination.totalPageCount == 1 || page <= pagination.totalPageCount) {
                        if (list.length > 0) {
                            list.forEach(obj => {
                                console.log('오브젝트=============');
                                console.log(obj);

                                html += `
                                <div class="col mb-5 list">
                                    <div class="card h-100">
                                        <img class="card-img-top" src="${obj.bbscttImage}" alt="..." />`

                                // 좋아요 버튼
                                html += `<span class="d-flex text-danger mb-2 like-btn" id="like_${obj.bbscttNo}" style="position: absolute; top: 0.5rem; right: 0.5rem">`;

                                if (likes.includes(obj.bbscttNo)) {
                                    html += `<i class="bi bi-heart-fill"></i>`;
                                } else {
                                    html += `<i class="bi bi-heart"></i>`;
                                }


                                html += `
                                    </span>
                                        <div class="card-body">
                                            <div class="text-center">
                                                <a href="javascript:void(0)" onclick="goViewPage(${obj.bbscttNo})">
                                                    <h6 class="fw-bolder">
                                                        ${obj.bbscttSj}
                                                    </h6>
                                                </a>
                            `;


                                // 별점
                                html += `<div class="d-flex justify-content-center small text-warning mb-2">`;
                                for (var i = 0; i < obj.bbscttGrade; i++) {
                                    html += '<div class="bi-star-fill"></div>';
                                }

                                for (var j = 0; j < 5 - obj.bbscttGrade; j++) {
                                    html += `<div class="bi-star"></div>`;
                                }
                                html += `</div>`;


                                // 해시태그(3개까지만 보이게 처리) - 해시태그 비어있을경우 처리 추가
                                if (obj.bbscttHashtag != null && obj.bbscttHashtag != '') {
                                    var tag = obj.bbscttHashtag.split(',');

                                    html += `<div class="text-xs">`;
                                    var showSize = tag.length > 3? 3 : tag.length;
                                    for (var k = 0; k < showSize; k++) {
                                        html += `<span class="text-primary">#` + tag[k] +' </span>';
                                    }
                                    html += `</div>`;
                                }

                                html +=
                                    `</div></div></div></div>`;
                            });
                        } else {
                            alert('데이터가 없습니다.');
                        }
                        $('#post-container').append(html);

                        // 좋아요 클릭 이벤트 추가
                        var likeBtns = document.querySelectorAll('.like-btn');
                        likeBtns.forEach( (btn) => {
                            btn.onclick = likePost;
                        });
                    }
                },
                error : function(err) {
                    console.log('err = ' + JSON.stringify(err));
                    if (err.status == 300) {
                        alert('데이터 로드 실패');
                    }
                }
            });
        }

        /* 게시글 리스트 조회 E */


        /* 좋아요 처리 S */
        function likePost() {
            var testId = [[${memberInfo.id}]]; // 로그인 멤버아이디
            var likeId = $(this).attr('id'); // 좋아요버튼 아이디
            var index = + likeId.substring(likeId.indexOf('_')+1); // 게시물아이디(index)
            var $heart = $(this).find('i'); // 하트 아이콘

            if ( $heart.hasClass('bi-heart-fill') ) { // 이걸로 해도 되고.... 글번호 포함하고 있는지 여부로 해도되고...
                // 좋아요 취소 ajax
                $.ajax({
                    type: "get",
                    dataType: "text",
                    async: false,
                    url: "/board/deleteLike",
                    data: { id: testId, idx: index },
                    success: function (data) {
                        if (data === 'success') {
                            alert('좋아요 취소 성공');
                            $heart.removeClass('bi-heart-fill');
                            $heart.addClass('bi-heart');

                        } else {
                            alert('좋아요 취소 실패');
                        }
                    },
                    error: function () {
                        alert('좋아요 취소 실패');
                    }
                });


            } else {
                // 좋아요 추가 ajax
                $.ajax({
                    type: "get",
                    dataType: "text",
                    async: false,
                    url: "/board/addLike",
                    data: { id: testId, idx: index },
                    success: function (data) {
                        if (data === 'success') {
                            alert('좋아요 추가 성공');
                            $heart.removeClass('bi-heart');
                            $heart.addClass('bi-heart-fill');

                        } else {
                            alert('좋아요 추가 실패');
                        }
                    },
                    error: function () {
                        alert('좋아요 추가 실패');
                    }
                });
            }
        }
        /* 좋아요 처리 E */


        /* 게시글 상세페이지 이동 */
        function goViewPage(idx) {
            var queryString = (location.search) ? location.search + `&idx=${idx}` : `?idx=${idx}`;
            location.href = '/board/view.do' + queryString;
        }
        /* 게시글 상세페이지 이동 */

        /* 게시글 리스트 조회 S */

    </script>

</th:block>

</html>