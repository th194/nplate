<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="bootstrap-template/layout/basic">
<th:block layout:fragment="title">
	<title>this is view page</title>
</th:block>

<th:block layout:fragment="modal">
	<div id="replyModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="replyModal" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<form>
						<div class="form-group">
							<label for="modalAnswerWrter" class="col-form-label">작성자</label>
							<input type="text" id="modalAnswerWrter" class="form-control" placeholder="작성자를 입력해주세요." disabled="disabled" />
						</div>
						<div class="form-group">
							<label for="modalAnswerCn" class="col-form-label">내용</label>
							<textarea id="modalAnswerCn" class="form-control" placeholder="내용을 입력해 주세요."></textarea>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" id="btnModalCancel" class="btn btn-default waves-effect waves-light" data-dismiss="modal">취소하기</button>
					<button type="button" id="btnReplyUpdate" class="btn btn-primary waves-effect waves-light">수정하기</button>
					<button type="button" id="btnReplyDelete" class="btn btn-danger waves-effect waves-light">삭제하기</button>
				</div>
			</div>
		</div>
	</div>
</th:block>

<th:block layout:fragment="main-content">
	<form class="form-horizontal form-view form-grade" th:object="${board}">
		<!-- Page content-->
		<div class="container mt-5">
			<div class="col">
				<div class="col-lg-12">
					<!-- Post content-->
					<article>
						<!-- Post header-->
						<header class="mb-4">
							<!-- Post title-->
							<h1 class="fw-bolder mb-1" style="border-bottom: 0.05rem solid #858796;" th:text="*{bbscttSj}"></h1>
							<!-- Post meta content-->
							<div class="text-muted fst-italic mb-2">
								<span style="margin-left:30px;" th:text="*{bbscttWrter}"></span>
								<span style="float:right;" th:text="*{bbscttRgsde}"></span>
								<span style="margin-left:30px;" id="hashAfter">
									<fieldset>
										<input type="radio" name="bbscttGrade" value="5" id="rate1">
										<label for="rate1" class="grade">⭐</label>
										<input type="radio" name="bbscttGrade" value="4" id="rate2">
										<label for="rate2" class="grade">⭐</label>
										<input type="radio" name="bbscttGrade" value="3" id="rate3">
										<label for="rate3" class="grade">⭐</label>
										<input type="radio" name="bbscttGrade" value="2" id="rate4">
										<label for="rate4" class="grade">⭐</label>
										<input type="radio" name="bbscttGrade" value="1" id="rate5">
										<label for="rate5" class="grade">⭐</label>
									</fieldset>
                                </span>
							</div>
							<!-- Post categories-->
						</header>
						<!-- Preview image figure-->
						<figure class="mb-4">
							<div class="map-size" id="map"></div>
						</figure>

						<!-- Post content-->
						<section class="mb-5">
							<textarea id="bbscttCn" rows="10" colse="100" style="width:100%; height:500px; min-width:600px; display: none;" th:text="${board.bbscttCn}"></textarea>
						</section>
					</article>
					<!-- Comments section-->
				</div>
			</div>
		</div>
	</form>

	<div class="card-content">
		<div class="btn_wrap text-center">
			<a href="javascript:void(0)" onclick="goListPage()" class="btn btn-secondary btn-icon-split">
					<span class="icon text-white-50">
						<i class="fas fa-arrow-right"></i>
					</span>
				<span class="text">뒤로가기</span>
			</a>
			<a th:if="${board.bbscttWrter == memberInfo.getId()}" href="javascript:void(0)" onclick="goWritePage()" class="btn btn-warning btn-icon-split">
					<span class="icon text-white-50">
						<i class="fas fa-exclamation-triangle"></i>
					</span>
				<span class="text">수정하기</span>
			</a>
			<a th:if="${board.bbscttWrter == memberInfo.getId()}" href="javascript:void(0)" onclick="deleteBoard()" class="btn btn-danger btn-icon-split">
					<span class="icon text-white-50">
						<i class="fas fa-trash"></i>
					</span>
				<span class="text">삭제하기</span>
			</a>
		</div>
	</div>
	<!-- /.card-content -->
	<hr>
	<!-- 댓글 -->
	<section class="mb-5">
		<div class="card bg-light">
			<div class="card-body">
				<!-- 댓글 목록 -->
				<div class="col-lg-12" id="replyList">

				</div>
				<!-- 댓글 페이징 -->
				<ul class="pagination" style="justify-content: center">

				</ul>
				<!-- 댓글 목록 -->
				<!-- Comment form-->
				<form class="mb-4" th:object="${board}">
					<textarea id="answerCn" name="answerCn" class="form-control" rows="3" style="resize: none;" placeholder="댓글 입력"></textarea>
					<a href="javascript:void(0)" class="btn btn-light btn-icon-split" th:onclick="insertReply()" style="float:right">
						<span class="icon text-gray-600">
							<i class="fas fa-arrow-right"></i>
						</span>
						<span class="text">댓글 등록</span>
					</a>
				</form>
			</div>

		</div>
	</section>
	<!-- 댓글 -->

</th:block>

<th:block layout:fragment="script">
	<script th:inline="javascript">
		/*<![CDATA[*/
		var loginMember;
		var board = [[${board}]];
		$(function(){
			var page = 1;
			replyList(page);
		});

		/* 댓글 목록 S */
		function replyList(page) {
			page = page ? page : 1;
			var uri = /*[[@{/reply/} + ${board.bbscttNo}]]*/"";
			var replyHtml = '';
			$.get(uri,
					{page : page, limitStart : page * 10},
				function (response) {
					loginMember = response.member;
					console.log('replyList => ',response.replyList);
					if (response.replyList !== undefined) {
						$(response.replyList).each(function (idx, reply) {
							var rgsde = reply.answerRgsde;
							var rgsdeFormt = timeForToday(rgsde);
							replyHtml += `
								<div class="d-flex mb-2" data-index="${reply.answerNo}">
									<div class="flex-shrink-0"><img class="rounded-circle" style="width:30px; height: 30px;" src="/member/info/profile?id=${response.profile[idx]}" alt="..." /></div>
									<div class="ms-3" style="width:70%">
										<div class="fw-bold">${reply.answerWrter}</div>
										${reply.answerCn}
									</div>
									`;
							// 로그인 한 사용자가 댓글 작성자와 같을 경우 수정/삭제 버튼 생성
							if (loginMember == reply.answerWrter) {
								replyHtml += `
										<div class="right-flex">
											<a class="btn btn-info btn-circle btn-sm right-flex" onclick="openModal(${reply.answerNo}, '${reply.answerWrter}', '${reply.answerCn}')">
												<i class="fas fa-info-circle" aria-hidden="true"></i>
											</a>
										`;
							}
							replyHtml += `
										<div class="right-flex" style="align-self: flex-end">${rgsdeFormt}</div>
									</div>
								</div>
								`;
						});
					} else {
						replyHtml += `
									<p>아직 댓글이 없습니다.</p>
									`;
					}
					$('#replyList').html(replyHtml);
					if(response.replyList != null && response.replyList != '') {
						drawPage(response.pagination.pagination, page);
						page++;
					}
				}, 'json');
			/* 댓글 목록 E */
		}

		/* 댓글 페이징 S */
		function drawPage(pagination, page) {
			$('.pagination').empty();

			var html = '';

			// 첫 페이지, 이전 페이지
			if (pagination.existPrevPage) {
				html += `
                    <li class="paginate_button page-item">
                        <a href="javascript:void(0)" aria-controls="dataTable" class="page-link" onclick="movePage(1)" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li class="paginate_button page-item">
                        <a href="javascript:void(0)" aria-controls="dataTable" class="page-link" onclick="movePage(${pagination.startPage - 1});" aria-label="Previous">
                        <span aria-hidden="true">&lsaquo;</span>
                        </a>
                    </li>
                `;
			}

			// 페이지 번호
			for (var i = pagination.startPage; i <= pagination.endPage; i++) {
				var active = (i === page) ? 'active' : '';
				html += `
                <li  class="${active} paginate_button page-item">
                    <a href="javascript:void(0)" aria-controls="dataTable" class="page-link" onclick="movePage(${i});">${i}</a>
                </li>
                `;
			}

			if (pagination.existNextPage) {
				html += `
                <li class="paginate_button page-item">
                    <a href="javascript:void(0)" aria-controls="dataTable" class="page-link" onclick="movePage(${pagination.endPage + 1});" aria-label="Next">
                        <span aria-hidden="true">&rsaquo;</span>
                    </a>
                </li>
                <li class="paginate_button page-item">
                    <a href="javascript:void(0)" aria-controls="dataTable" class="page-link" onclick="movePage(${pagination.totalPageCount});" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                `;
			}

			$('.pagination').append(html);
		}
		/* 댓글 페이징 E */

		/* 댓글 페이지 이동 S */
		function movePage(page) {
			replyList(page);
		}

		/* 댓글 페이지 이동 E */




		/* 화면 렌더링 */
		// 별점
		$('input[name=bbscttGrade]').attr('disabled', true);

		switch (board.bbscttGrade) {
			case 1 :
				$('#rate5').attr('checked', true);
				break;
			case 2 :
				$('#rate4').attr('checked', true);
				break;
			case 3 :
				$('#rate3').attr('checked', true);
				break;
			case 4 :
				$('#rate2').attr('checked', true);
				break;
			case 5 :
				$('#rate1').attr('checked', true);
				break;
		}

		// 해시태그
		var hashTagList = [];
		var hashTagListDom = '';

		if(board.bbscttHashtag != null && board.bbscttHashtag != '') {
			if ((board.bbscttHashtag).indexOf(',') != -1) {
				hashTagList = (board.bbscttHashtag).split(',');
				hashTagList.forEach((value) => {
					hashTagListDom += `
							<a class="badge bg-secondary text-gray-100 text-decoration-none link-light" style="margin-left:30px;" href="#!">${value}</a>
						`;
				});
			} else {
				hashTagList = board.bbscttHashtag;
				hashTagListDom += `<a class="badge bg-secondary text-gray-100 text-decoration-none link-light" style="margin-left:30px;" href="#!">${hashTagList}</a>`;
			}
			$('#hashAfter').before(hashTagListDom);
			hashTagListDom = '';
		}
		/* 화면 렌더링 */

		/*게시글 삭제 함수*/
		function deleteBoard() {
			var idx = board.bbscttNo;
			if (!confirm(idx + "번 게시글을 삭제할까요?")) {
				return false;
			}

			var inputHtml = "";
			new URLSearchParams(location.search).forEach((value, key) => {
				inputHtml += `<input type="hidden" name="${key}" value="${value}" />`;
			});

			var formHtml = `<form id="deleteForm" action="/board/delete.do" method="post">
								${inputHtml}
							</form>`;

			var doc = new DOMParser().parseFromString(formHtml, 'text/html');
			var form = doc.body.firstChild;
			document.body.append(form);
			document.getElementById('deleteForm').submit();
		}
		/*게시글 삭제 함수*/

		var $map = document.getElementById('map');

		var options = {
			center : new kakao.maps.LatLng(board.bbscttCchLa, board.bbscttCchLo),
			level : 3
		}

		// 지도 생성
		var map = new kakao.maps.Map($map, options);

		// 마커가 표시될 위치
		var markerPosition = new kakao.maps.LatLng(board.bbscttCchLa, board.bbscttCchLo);

		// 마커 생성
		var marker = new kakao.maps.Marker({
			position : markerPosition
		});

		// 마커생성
		marker.setMap(map);

		var iwContent = `<div style="padding:5px;">${board.bbscttStore}<br></div>`; // 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
		var iwPosition = new kakao.maps.LatLng(board.bbscttCchLa, board.bbscttCchLo); //인포윈도우 표시 위치입니다

		// 인포윈도우를 생성합니다
		var infowindow = new kakao.maps.InfoWindow({
			position : iwPosition,
			content : iwContent
		});

		// 마커 위에 인포윈도우를 표시합니다. 두번째 파라미터인 marker를 넣어주지 않으면 지도 위에 표시됩니다
		infowindow.open(map, marker);

		// $map.append(map);


		/* smartEditor */
		var oEditors = [];

		smartEditor = function() {
			nhn.husky.EZCreator.createInIFrame({
				oAppRef : oEditors,
				elPlaceHolder : 'bbscttCn',
				sSkinURI: '/smarteditor/SmartEditor2Skin.html',
				fCreator: 'createSEditor2',
				htParams: {
					bUseToolbar : false,					// 툴바 사용 여부 (true : 사용 / false : 사용하지 않음)
					bUseVerticalResizer : false,			// 입력창 크기 조절바 사용 여부 ( true : 사용 / false : 사용하지 않음)
					bUseModeChanger : false				// 모드 탭 (Editor | HTML | TEXT ) 사용 여부 (true : 사용 / false : 사용하지 않음)
				},
				fOnAppLoad : function() {
					var editor = oEditors.getById['bbscttCn'];
					// editor.exec('PASTE_HTML', [board.bbscttCn]);
					editor.exec('DISABLE_WYSIWYG');
					editor.exec('DISABLE_ALL_UI');
				}
			});
		}
		smartEditor();
		/* smartEditor */

		/* 수정하기 */
		function goWritePage() {
			location.href = '/member/board/write' + location.search;
		}
		/* 수정하기 */

		/* 뒤로가기 */
		function goListPage() {
			var queryString = new URLSearchParams(location.search);
			queryString.delete('idx');
			location.href = '/member/board/list?' + queryString.toString();
		}
		/* 뒤로가기 */

		/* 댓글 등록 S */
		function insertReply() {
			var answerCn = document.getElementById('answerCn');
			if ( answerCn.value == null || answerCn.value == '') {
				alert('댓글을 입력해주세요.');
				answerCn.focus();
				return false;
			}

			var uri = /*[[@{/reply}]]*/"";
			var headers = {
				'Content-type' : 'application/json',
				'X-HTTP-Method-Override' : 'POST'
			};
			var params = {
				bbscttNo : board.bbscttNo,
				answerCn : answerCn.value,
				answerWrter : loginMember
			}

			$.ajax({
				url : uri,
				type : 'POST',
				headers : headers,
				dataType : 'json',
				data : JSON.stringify(params),
				success : function(result) {
					var date = moment().format('YYYY-MM-DD HH:mm:ss');
					if (result.result == false) {
						alert('댓글 등록 실패');
						return false;
					}

					stompClient.send('/pub/' + board.bbscttWrter, {}, JSON.stringify({writer: board.bbscttWrter, alarmType : 'reply', member : loginMember, date : date}));

					var alarmData = {
						ntcnReceiveMber : board.bbscttWrter,			// 알람 받는 사람 id
						ntcnSendMber 	: loginMember,			// 알람 보내는 사람 id
						ntcnKnd			: 'reply',			// 알람 타입 ( 삭제 : 'delete', 팔로잉 : 'following', 좋아요 : 'like', 댓글 : 'reply' )
						ntcnTrgtNo		: board.bbscttNo,			// 알람 타겟 게시글 번호
						ntcnTrgtSj		: board.bbscttSj			// 알람 타겟 게시글 제목
					};

					$.ajax({
						url : '/alarm/register',
						type : 'POST',
						data : alarmData
					});
					replyList();
					answerCn.value = '';
				},
				error : function(err) {
					console.log(JSON.stringify(err));
					return false;
				}
			});

		}
		/* 댓글 등록 E */

		/* 댓글 수정/삭제 모달 오픈 S */
		function openModal(idx, writer, content) {
			$('#replyModal').modal('show');

			$('#modalAnswerWrter').val(writer);
			$('#modalAnswerCn').val(content);

			document.getElementById('btnReplyUpdate').setAttribute('onclick', 'updateReply('+ idx + ')');
			document.getElementById('btnReplyDelete').setAttribute('onclick', 'deleteReply('+ idx + ')');
		}
		/* 댓글 수정/삭제 모달 오픈 S */

		/* 댓글 수정 S */
		function updateReply(idx) {
			var writer = $('#modalAnswerWrter').val();
			var content = $('#modalAnswerCn').val();

			var uri = '/reply/' + idx;
			var headers = {
				'Content-Type': 'application/json',
				'X-HTTP-Method-Override' : 'PATCH'
			};
			var params = {
				answerNo : idx,
				answerCn : content,
				answerWrter: writer
			}

			$.ajax({
				url : uri,
				type : 'PATCH',
				headers : headers,
				dataType: 'json',
				data : JSON.stringify(params),
				success : function(result) {
					if (result.result == false) {
						alert('수정 실패');
						return false;
					}
					replyList();
					$('#replyModal').modal('hide');

				},
				error : function(err) {
					console.log('err = ' + JSON.stringify(err));
					return;
				}
			});
		}
		/* 댓글 수정 E */

		/* 댓글 삭제 S */
		function deleteReply(idx) {
			if (!confirm('댓글을 삭제 하시겠습니까?')) {
				return false;
			}

			var uri = '/reply/' + idx;
			console.log('삭제 uri = ' + uri);
			var headers = {
				'Content-Type' : 'application/json',
				'X-HTTP-Method-Override' : 'DELETE'
			};
			$.ajax({
				url : uri,
				type : 'DELETE',
				headers : headers,
				dataType : 'json',
				success : function(result) {
					if (result.result == false) {
						alert('댓글 삭제 실패');
						return false;
					}

					$.ajax({
						url : '/alarm/delete',
						type : 'POST',
						data : {ntcnTrgtSj : board.bbscttSj}
					})

					replyList();
					$('#replyModal').modal('hide');
				},
				error : function(err) {
					console.log('err = ' + JSON.stringify(err));
					return false;
				}
			});
		}
		/* 댓글 삭제 E */


		/* 팔로잉하기 S */
		function following(id) {
			console.log('팔로잉 함수=================');
			console.log('id===========');
			console.log(id);

			$.ajax({
				type: "get",
				dataType: "json",
				async: false,
				url: "/member/following",
				data: { id: id },
				success: function (data) {
					if (data.result === 'success') {
						alert('팔로잉 성공');
						const promise = new Promise((resolve) => {

							stompClient.send('/pub/' + id, {}, JSON.stringify({writer: id, alarmType : 'following', member : memberInfo.id, date : date}));

							var alarmData = {
								ntcnReceiveMber : id,			            // 알람 받는 사람 id
								ntcnSendMber 	: memberInfo.id,			// 알람 보내는 사람 id
								ntcnKnd			: 'following',			    // 알람 타입 ( 삭제 : 'delete', 팔로잉 : 'following', 좋아요 : 'like', 댓글 : 'reply' )
								ntcnTrgtSj      : memberInfo.id             // 팔로잉때는 게시글 제목이 없으므로 알람 보내는 사람 id 넣어준다.
							};

							$.ajax({
								url : '/alarm/register',
								type : 'POST',
								data : alarmData
							})
							resolve();
						});
						promise.then(() => {
							location.reload(); // 버튼 바꾸기 위해 새로고침 해줌
						});
					} else {
						alert('팔로잉 실패');
					}
				},
				error: function () {
					alert('팔로잉 실패');
				}
			});
		}

		function unfollowing(id) {
			console.log('언팔로잉 함수=================');
			console.log('id===========');
			console.log(id);

			$.ajax({
				type: "get",
				dataType: "text",
				async: false,
				url: "/member/unfollowing",
				data: { id: id },
				success: function (data) {
					if (data === 'success') {
						$.ajax({
							url : '/alarm/delete',
							type : 'POST',
							data : {ntcnKnd : 'following'}
						});
						alert('언팔로잉 성공');
						location.reload();
					} else {
						alert('언팔로잉 실패');
					}
				},
				error: function () {
					alert('언팔로잉 실패');
				}
			});
		}
		/* 팔로잉하기 E */
		/*]]>*/
	</script>
</th:block>
</html>