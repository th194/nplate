<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="bootstrap-template/layout/basic">
	<th:block layout:fragment="title">
		<title>this is view page</title>
	</th:block>

	<th:block layout:fragment="modal">
		<div id="replyModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="replyModal" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<form>
							<div class="form-group">
								<label for="modalAnswerWrter" class="col-form-label">작성자</label>
								<input type="text" id="modalAnswerWrter" class="form-control" placeholder="작성자를 입력해 주세요." />
							</div>
							<div class="form-group">
								<label for="modalAnswerCn" class="col-form-label">내용</label>
								<textarea id="modalAnswerCn" class="form-control" placeholder="내용을 입력해 주세요."></textarea>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" id="btnModalCancel" class="btn btn-default waves-effect waves-light" data-dismiss="modal">취소하기</button>
						<button type="button" id="btnReplyUpdate" class="btn btn-primary waves-effect waves-light">수정하기</button>
						<button type="button" id="btnReplyDelete" class="btn btn-danger waves-effect waves-light">삭제하기</button>
					</div>
				</div>
			</div>
		</div>
	</th:block>

	<th:block layout:fragment="main-content">
		<div class="card-content">
			<form class="form-horizontal form-view form-grade" th:object="${board}">
				<div class="form-group">
					<label for="bbscttSj" class="col-sm-2 control-label">제목</label>
					<div class="col-sm-10">
						<p class="form-control" th:text="*{bbscttSj}"></p>
					</div>
				</div>

				<div class="form-group">
					<label for="bbscttWrter" class="col-sm-2 control-label">이름</label>
					<div class="col-sm-10">
						<div class="form-control dropdown no-arrow">
							<a class="dropdown-toggle" href="#" id="userDropdown1" role="button"
							   data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<span class="text-dark" th:text="*{bbscttWrter}"></span>
							</a>
							<div class="dropdown-menu" aria-labelledby="userDropdown1">
								<a class="dropdown-item" th:href="'/member/userInfo?id=' + *{bbscttWrter}">
									<i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
									개인 페이지
								</a>
								<div class="dropdown-divider" th:if="${memberInfo.id} != *{bbscttWrter}"></div>
								<a class="dropdown-item following-btn" href="#" th:if="!${isFollowing} and ${memberInfo.id} != *{bbscttWrter}"
								   th:following="*{bbscttWrter}" th:onclick="following(this.getAttribute('following'))">
									<i class="bi bi-person-plus mr-2 text-gray-400"></i>
									팔로잉
								</a>
								<a class="dropdown-item" href="#" th:if="${isFollowing} and ${memberInfo.id} != *{bbscttWrter}"
								   th:following="*{bbscttWrter}" th:onclick="unfollowing(this.getAttribute('following'))">
									<i class="bi bi-person-x mr-2 text-gray-400"></i>
									언팔로잉
								</a>
							</div>
						</div>
					</div>
				</div>

				<div class="form-group">
					<label for="inp-type-5" class="col-sm-2 control-label">위치</label>
					<div class="map-size" id="map"></div>
				</div>

				<div class="form-group">
					<label for="bbscttCn" class="col-sm-2 control-label">내용</label>
					<div class="col-sm-10">
						<textarea id="bbscttCn" class="form-control" th:text="*{bbscttCn}"></textarea>
					</div>
				</div>

				<div class="form-group">
					<label for="rate1" class="col-sm-2 control-label">평점</label>
					<fieldset>
						<input type="radio" name="bbscttGrade" value="5" id="rate1">
						<label for="rate1" class="grade">⭐</label>
						<input type="radio" name="bbscttGrade" value="4" id="rate2">
						<label for="rate2" class="grade">⭐</label>
						<input type="radio" name="bbscttGrade" value="3" id="rate3">
						<label for="rate3" class="grade">⭐</label>
						<input type="radio" name="bbscttGrade" value="2" id="rate4">
						<label for="rate4" class="grade">⭐</label>
						<input type="radio" name="bbscttGrade" value="1" id="rate5">
						<label for="rate5" class="grade">⭐</label>
					</fieldset>
				</div>


				<div class="form-group">
					<label for="bbscttHashtag" class="col-sm-2 control-label">해시태그</label>
					<div class="col-sm-10">
						<p class="form-control" th:text="*{bbscttHashtag}"></p>
					</div>
				</div>

				<div class="form-group">
					<label for="bbscttRgsde" class="col-sm-2 control-label">등록일</label>
					<div class="col-sm-10">
						<p class="form-control" th:text="*{bbscttRgsde}"></p>
					</div>
				</div>
				<div class="form-group">
					<label for="bbscttRdcnt" class="col-sm-2 control-label">조회 수</label>
					<div class="col-sm-10">
						<p class="form-control" th:text="*{bbscttRdcnt}"></p>
					</div>
				</div>
			</form>

			<div class="btn_wrap text-center">
				<a href="javascript:void(0)" onclick="goListPage()" class="btn btn-default waves-effect waves-light">뒤로가기</a>
				<a href="javascript:void(0)" onclick="goWritePage()" class="btn btn-primary waves-effect waves-light">수정하기</a>
				<button type="button" class="btn btn-danger waves-effect waves-light" th:onclick="deleteBoard()">삭제하기</button>
			</div>
		</div>
		<!-- /.card-content -->
		<hr>

		<!-- 댓글 등록 영역 -->
		<h3> 댓 글 </h3>
		<form class="form-horizontal form-view form-grade" th:object="${board}">
			<div class="form-group">
				<input type="text" id="answerCn" name="answerCn" class="form-control" style="width: 700px"/>
				<div class="input-group" style="display: inline-block; padding-left: 5px">
					<a class="btn btn-success btn-circle btn-sm" th:onclick="insertReply()">
						<i class="fas fa-check" aria-hidden="true"></i>
					</a>
				</div>
			</div>
		</form>
		<!-- 댓글 등록 영역 -->

		<!-- 댓글 목록 영역 -->
		<div class="card shadow mb-4">
			<div class="card-body">
				<div class="table-responsive">
					<table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
						<thead>
						<tr>
							<th>번호</th>
							<th>내용</th>
							<th>작성자</th>
							<th>등록일</th>
							<th>수정/삭제</th>
						</tr>
						</thead>
						<tbody id="replyList">
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<!-- 댓글 목록 영역 -->
	</th:block>

	<th:block layout:fragment="script">
		<script th:inline="javascript">
			/*<![CDATA[*/

			var loginMember;

			$(function(){
				replyList();
			});

			/* 댓글 목록 S */
			function replyList() {
				var uri = /*[[@{/reply/} + ${board.bbscttNo}]]*/"";
				var replyHtml = '';

				console.log('목록 uri = ' + uri);

				$.get(uri, function(response) {
					loginMember = response.member;
					console.log('replyList = ' + response.replyList);
					if (response.replyList !== undefined) {
						console.log('로그인 사용자 = ' + loginMember);
						$(response.replyList).each(function(idx, reply) {
							replyHtml += `
							<tr>
							<td>${reply.answerNo}</td>
							<td>${reply.answerCn}</td>
							<td>${reply.answerWrter}</td>
							<td>${moment(reply.answerRgsde).format('YYYY-MM-DD HH:mm:ss')}</td>
							<td>`;

							// 세션의 로그인한 사용자와 댓글 작성자가 같을 경우만 수정/삭제 버튼 생성
							if(loginMember == reply.answerWrter) {

								replyHtml +=`
										<a class="btn btn-info btn-circle btn-sm" onclick="openModal(${reply.answerNo}, '${reply.answerWrter}', '${reply.answerCn}')">
											<i class="fas fa-info-circle" aria-hidden="true"></i>
										</a>
									</td>
								</tr>
								`;
							} else {
								replyHtml += `
								</td>
								</tr>
								`;
							}
						});
					} else {
						replyHtml += `
								<tr><td colspan="5">아직 댓글이 없습니다.</td></tr>
								`;
					}
					$('#replyList').html(replyHtml);
				}, 'json');
			}
			/* 댓글 목록 S */


			var board = [[${board}]];
			console.log('board = ' + JSON.stringify(board));

			/* 평점 렌더링 */
			$('input[name=bbscttGrade]').attr('disabled', true);

			console.log('별점 점수 ============================== ' + board.bbscttGrade);
			switch (board.bbscttGrade) {
				case 1 :
					$('#rate5').attr('checked', true);
					break;
				case 2 :
					$('#rate4').attr('checked', true);
					break;
				case 3 :
					$('#rate3').attr('checked', true);
					break;
				case 4 :
					$('#rate2').attr('checked', true);
					break;
				case 5 :
					$('#rate1').attr('checked', true);
					break;
			}
			/* 평점 렌더링 */

			/*게시글 삭제 함수*/
			function deleteBoard() {
				var idx = board.bbscttNo;
				if (!confirm(idx + "번 게시글을 삭제할까요?")) {
					return false;
				}

				var inputHtml = "";
				new URLSearchParams(location.search).forEach((value, key) => {
					inputHtml += `<input type="hidden" name="${key}" value="${value}" />`;
				});

				var formHtml = `<form id="deleteForm" action="/board/delete.do" method="post">
									${inputHtml}
								</form>`;

				var doc = new DOMParser().parseFromString(formHtml, 'text/html');
				var form = doc.body.firstChild;
				document.body.append(form);
				document.getElementById('deleteForm').submit();
			}
			/*게시글 삭제 함수*/

			var $map = document.getElementById('map');

			var options = {
				center : new kakao.maps.LatLng(board.bbscttCchLa, board.bbscttCchLo),
				level : 3
			}

			// 지도 생성
			var map = new kakao.maps.Map($map, options);

			// 마커가 표시될 위치
			var markerPosition = new kakao.maps.LatLng(board.bbscttCchLa, board.bbscttCchLo);

			// 마커 생성
			var marker = new kakao.maps.Marker({
				position : markerPosition
			});

			// 마커생성
			marker.setMap(map);

			$map.append(map);


			/* smartEditor */
			var oEditors = [];

			smartEditor = function() {
				nhn.husky.EZCreator.createInIFrame({
					oAppRef : oEditors,
					elPlaceHolder : 'bbscttCn',
					sSkinURI: '/smarteditor/SmartEditor2Skin.html',
					fCreator: 'createSEditor2',
					htParams: {
						bUseToolbar : false,					// 툴바 사용 여부 (true : 사용 / false : 사용하지 않음)
						bUseVerticalResizer : false,			// 입력창 크기 조절바 사용 여부 ( true : 사용 / false : 사용하지 않음)
						bUseModeChanger : false				// 모드 탭 (Editor | HTML | TEXT ) 사용 여부 (true : 사용 / false : 사용하지 않음)
					},
					fOnAppLoad : function() {
						var editor = oEditors.getById['bbscttCn'];
						// editor.exec('PASTE_HTML', [board.bbscttCn]);
						editor.exec('DISABLE_WYSIWYG');
						editor.exec('DISABLE_ALL_UI');
					}
				});
			}
			smartEditor();
			/* smartEditor */

			/* 수정하기 */
			function goWritePage() {
				location.href = '/member/board/write' + location.search;
			}
			/* 수정하기 */

			/* 뒤로가기 */
			function goListPage() {
				var queryString = new URLSearchParams(location.search);
				queryString.delete('idx');
				location.href = '/member/board/list?' + queryString.toString();
			}
			/* 뒤로가기 */

			/* 댓글 등록 S */
			function insertReply() {
				var answerCn = document.getElementById('answerCn');
				if ( answerCn.value == null || answerCn.value == '') {
					answerCn.setAttribute("placeholder", '댓글을 입력해주세요.');
					answerCn.focus();
					return false;
				}

				var uri = /*[[@{/reply}]]*/"";
				var headers = {
					'Content-type' : 'application/json',
					'X-HTTP-Method-Override' : 'POST'
				};
				var params = {
					bbscttNo : board.bbscttNo,
					answerCn : answerCn.value,
					answerWrter : loginMember
				}

				$.ajax({
					url : uri,
					type : 'POST',
					headers : headers,
					dataType : 'json',
					data : JSON.stringify(params),
					success : function(result) {
						if (result.result == false) {
							alert('댓글 등록 실패');
							return false;
						}
						replyList();
						answerCn.value = '';
					},
					error : function(err) {
						console.log(JSON.stringify(err));
						return false;
					}
				});

			}
			/* 댓글 등록 E */

			/* 댓글 수정/삭제 모달 오픈 S */
			function openModal(idx, writer, content) {
				$('#replyModal').modal('show');

				$('#modalAnswerWrter').val(writer);
				$('#modalAnswerCn').val(content);

				document.getElementById('btnReplyUpdate').setAttribute('onclick', 'updateReply('+ idx + ')');
				document.getElementById('btnReplyDelete').setAttribute('onclick', 'deleteReply('+ idx + ')');
			}
			/* 댓글 수정/삭제 모달 오픈 S */

			/* 댓글 수정 S */
			function updateReply(idx) {
				var writer = $('#modalAnswerWrter').val();
				var content = $('#modalAnswerCn').val();

				var uri = '/reply/' + idx;
				console.log('수정 uri = ' + uri);
				var headers = {
					'Content-Type': 'application/json',
					'X-HTTP-Method-Override' : 'PATCH'
				};
				var params = {
					answerNo : idx,
					answerCn : content,
					answerWrter: writer
				}

				$.ajax({
					url : uri,
					type : 'PATCH',
					headers : headers,
					dataType: 'json',
					data : JSON.stringify(params),
					success : function(result) {
						if (result.result == false) {
							alert('수정 실패');
							return false;
						}
						replyList();
						$('#replyModal').modal('hide');

					},
					error : function(err) {
						console.log('err = ' + JSON.stringify(err));
						return;
					}
				});
			}
			/* 댓글 수정 E */

			/* 댓글 삭제 S */
			function deleteReply(idx) {
				if (!confirm('댓글을 삭제 하시겠습니까?')) {
					return false;
				}

				var uri = '/reply/' + idx;
				console.log('삭제 uri = ' + uri);
				var headers = {
					'Content-Type' : 'application/json',
					'X-HTTP-Method-Override' : 'DELETE'
				};
				$.ajax({
					url : uri,
					type : 'DELETE',
					headers : headers,
					dataType : 'json',
					success : function(result) {
						if (result.result == false) {
							alert('댓글 삭제 실패');
							return false;
						}
						replyList();
						$('#replyModal').modal('hide');
					},
					error : function(err) {
						console.log('err = ' + JSON.stringify(err));
						return false;
					}
				});
			}
			/* 댓글 삭제 E */


			/* 팔로잉하기 S */
			function following(id) {
				console.log('팔로잉 함수=================');
				console.log('id===========');
				console.log(id);

				$.ajax({
					type: "get",
					dataType: "text",
					async: false,
					url: "/member/following",
					data: { id: id },
					success: function (data) {
						if (data === 'success') {
							alert('팔로잉 성공');
							location.reload(); // 버튼 바꾸기 위해 새로고침 해줌
						} else {
							alert('팔로잉 실패');
						}
					},
					error: function () {
						alert('팔로잉 실패');
					}
				});
			}

			function unfollowing(id) {
				console.log('언팔로잉 함수=================');
				console.log('id===========');
				console.log(id);

				$.ajax({
					type: "get",
					dataType: "text",
					async: false,
					url: "/member/unfollowing",
					data: { id: id },
					success: function (data) {
						if (data === 'success') {
							alert('언팔로잉 성공');
							location.reload();
						} else {
							alert('언팔로잉 실패');
						}
					},
					error: function () {
						alert('언팔로잉 실패');
					}
				});
			}
			/* 팔로잉하기 E */



			/*[- end of function -]*/
			/*]]>*/
		</script>
	</th:block>
</html>