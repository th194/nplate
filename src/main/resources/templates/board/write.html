<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="board/layout/basic">
	<th:block layout:fragment="title">
		<title>게시글 등록</title>
	</th:block>

	<th:block layout:fragment="content">
		<div class="card-content">
			<form class="form-horizontal form-grade" th:action="@{/board/register.do}" th:object="${board}" method="post">
				<!--/* update의 경우 서버로 전달할 게시글 번호 (PK) */-->
<!--				<input type="hidden" th:if="*{bbscttNo != null and bbscttNo > 0}" th:field="*{bbscttNo}" />-->

				<!-- 작성자 -->
				<input type="hidden" th:field="*{bbscttWrter}" />

				<div class="form-group">
					<label for="bbscttSj" class="col-sm-2 control-label">제목</label>
					<div class="col-sm-10">
						<input type="text" th:field="*{bbscttSj}" class="form-control" placeholder="제목을 입력해 주세요." />
					</div>
				</div>

				<div class="form-group">
					<label for="btnMap" class="col-sm-2 control-label">장소등록</label>
					<div class="col-sm-10">
						<button id="btnMap" type="button" class="btn btn-primary waves-effect waves-light" onclick="openPopup()">장소등록</button>
						<div id="map" style="width:100%;height:350px;display: none"></div>
					</div>
				</div>

<!--				<div class="form-group">-->
<!--					<label for="bbscttWrter" class="col-sm-2 control-label">이름</label>-->
<!--					<div class="col-sm-10">-->
<!--						<input type="text" th:field="*{bbscttWrter}" class="form-control" placeholder="이름을 입력해 주세요." />-->
<!--					</div>-->
<!--				</div>-->

				<div class="form-group">
					<label for="bbscttCn" class="col-sm-2 control-label">내용</label>
					<div class="col-sm-10">
						<textarea id="bbscttCn" th:field="*{bbscttCn}" class="form-control" placeholder="내용을 입력해 주세요."></textarea>
					</div>
					<input type="file" th:field="*{bbscttImage}" style="display: none;"/>
				</div>

				<div class="form-group">
					<label for="bbscttGrade" class="col-sm-2 control-label">평점</label>
						<fieldset>
							<input type="radio" name="bbscttGrade" value="5" id="rate1"><label for="rate1" class="grade">⭐</label>
							<input type="radio" name="bbscttGrade" value="4" id="rate2"><label for="rate2" class="grade">⭐</label>
							<input type="radio" name="bbscttGrade" value="3" id="rate3"><label for="rate3" class="grade">⭐</label>
							<input type="radio" name="bbscttGrade" value="2" id="rate4"><label for="rate4" class="grade">⭐</label>
							<input type="radio" name="bbscttGrade" value="1" id="rate5"><label for="rate5" class="grade">⭐</label>
						</fieldset>
				</div>

					<div class="form-group hash-tag">
						<label for="bbscttHashtag" class="col-sm-2 control-label"></label>
						<ul id="tag-list"></ul>
						<div class="col-sm-10">
							<input type="hidden" id="bbscttHashtag" name="bbscttHashtag" value="" />

						</div>
					</div>

					<div class="form-group">
						<label for="tag" class="col-sm-2 control-label">해시태그</label>
						<div class="col-sm-10">
							<input type="text" id="tag" class="form-control" placeholder="엔터로 해시태그를 등록해주세요." />
						</div>
					</div>

				<div class="btn_wrap text-center">
					<a th:href="@{/board/list.do}" class="btn btn-default waves-effect waves-light">뒤로가기</a>
					<button type="button" th:onclick="submitPost()" class="btn btn-primary waves-effect waves-light">저장하기</button>
				</div>
			</form>


<!--			<input type="file" id="inputImage" />-->
<!--			<img style="width: 50px; height: 50px" id="previewImage" src="https://dummyimage.com/300x100/ffffff/000000.png&text=file upload"/>-->
<!--			<form th:field="fileForm" method="post">-->
<!--				<input type="hidden" th:field="fileNo" />-->
<!--				<input type="hidden" th:field="fileImageCode">-->
<!--				<input type="hidden" th:field="fileNm" />-->
<!--				<input type="hidden" th:field="fileNmTemp" />-->
<!--				<input type="hidden" th:field="fileCours" />-->
<!--			</form>-->
		</div>
		<!-- /.card-content -->
	</th:block>

	<th:block layout:fragment="script">
		<script th:inline="javascript">
			/*<![CDATA[*/

			/**
			 * 단일파일 업로드
			 */
			// function readImage(input) {
			// 	if (input.files && input.files[0]) {
			// 		const reader = new FileReader();
			//
			// 		reader.onload = (e) => {
			// 			const previewImage = document.getElementById('previewImage');
			// 			previewImage.src = e.target.result;
			// 		}
			// 		reader.readAsDataURL(input.files[0]);
			// 	}
			// }
			// // 이벤트 리스너
			// document.getElementById('inputImage').addEventListener('change', (e) => {
			// 	readImage(e.target);
			// });

			/* smartEditor */
			var oEditors = [];

			smartEditor = function() {
				console.log("naver SamrtEditor");
				nhn.husky.EZCreator.createInIFrame({
					oAppRef : oEditors,
					elPlaceHolder : 'bbscttCn',
					sSkinURI: '/smarteditor/SmartEditor2Skin.html',
					fCreator: 'createSEditor2'
				});
			}
			smartEditor();
			/* smartEditor */



			function insertIMG(filename) {
				var sHTML = '<img src="C:/kth/images/"' + filename + '>';
				oEditors.getById['bbscttCn'].exec('PASTE_HTML', [sHTML]);
			}

			function submitPost() {
				oEditors.getById['bbscttCn'].exec('UPDATE_CONTENTS_FIELD', []);

				// 스마트 에디터 태그 제거 (TODO 사용할지 말지..)
				// 에디터에서 엔터키 누르면 <p></p> 태그 생성되는데 태그는 지우고 내용만 디비에 저장하고 싶다..
				// 근데 태그 삭제하는 정규식 사용하면 에디터 내부에 생성되는 <img> 태그까지 지워짐..
				// 고민좀 해봐야할듯..
				// var content = document.getElementById('bbscttCn').value.replace(/[<][^>]*[>]/gi, "");

				// 일단 태그 안지움
				var content = document.getElementById('bbscttCn').value;

				console.log('content = ' + content);

				if(content == '') {
					alert('내용을 입력해주세요');
					oEditors.getById['bbscttCn'].exec('FOCUS');
					return;
				} else {
					var bbscttHashTag = marginTag();
					$('#bbscttHashtag').val(bbscttHashTag);


					var imgTag = document.getElementsByTagName('img');
					for(var i= 0; i < 3; i++) {
						console.log('imgTag =' + imgTag[i]);
					}



					var post = {
						bbscttSj : $('#bbscttSj').val(),
						bbscttWrter: $('#bbscttWrter').val(),
						bbscttCn : content,
						bbscttImage : $('#bbscttImage').val(),
						bbscttGrade : $('input[name=bbscttGrade]').val(),
						bbscttHashtag : $('#bbscttHashtag').val(),
						bbscttCchLa: $('input[name=bbscttCchLa]').val(),
						bbscttCchLo: $('input[name=bbscttCchLo]').val()
					}

					console.log('post = ' + post);

					$.ajax({
						url : '/board/register.do',
						data : post,
						method : 'POST',
						success : function(data) {
							console.log('success data > ', data);
							alert('저장');
							// location.href = '/board/list.do';
						},
						error : function(err) {
							console.log('err data > ', err);
							alert('실패');
						}
					})
				}
			}





			/* 해시태그 시작 */
			var tag = {};
			var counter = 0;

			// 입력한 값을 태그로 생성한다.
			function addTag (value) {
				tag[counter] = value;
				counter++; // del-btn 의 고유 id 가 된다.
			}

			// tag 안에 있는 값을 array type 으로 만들어서 넘긴다.
			function marginTag () {
				return Object.values(tag).filter(function (word) {
					return word !== "";
				});
			}

			$("#tag").on("keypress", function (e) {
				var self = $(this);

				//엔터나 스페이스바 눌렀을때 실행
				if (e.key === "Enter" || e.keyCode == 32) {

					var tagValue = self.val(); // 값 가져오기

					// 해시태그 값 없으면 실행X
					if (tagValue !== "") {

						// 같은 태그가 있는지 검사한다. 있다면 해당값이 array 로 return 된다.
						var result = Object.values(tag).filter(function (word) {
							return word === tagValue;
						})

						// 해시태그가 중복되었는지 확인
						if (result.length == 0) {
							$("#tag-list").append("<li class='tag-item'>"+tagValue+"<span class='del-btn' idx='"+counter+"'>x</span></li>");
							addTag(tagValue);
							self.val("");
						} else {
							alert("태그값이 중복됩니다.");
						}
					}
					e.preventDefault(); // SpaceBar 시 빈공간이 생기지 않도록 방지
				}
			});

			// 삭제 버튼
			// 인덱스 검사 후 삭제
			$(document).on("click", ".del-btn", function (e) {
				var index = $(this).attr("idx");
				tag[index] = "";
				$(this).parent().remove();
			});
			/* 해시태그 끝 */



			/* 게시글 등록/수정 validation */
			function registerBoard(form) {
			}
			/* 게시글 등록/수정 validation */



			/* 지도 관련 */
			function openPopup() {
				window.open('/board/mapPopup', 'pop', 'width=1000, height=1000, scrollbars=yes');
			}

			function getMapInfo(lat, lng) {
				console.log('위도:' + lat + ' / 경도:' + lng);

				var mapContainer = document.getElementById('map'), // 지도를 표시할 div
						mapOption = {
							center: new kakao.maps.LatLng(lat, lng), // 지도의 중심좌표
							level: 2 // 지도의 확대 레벨
						};

				mapContainer.style.display='block';

				// 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
				var map = new kakao.maps.Map(mapContainer, mapOption);

				// 지도를 클릭한 위치에 표출할 마커입니다
				var marker = new kakao.maps.Marker({
					// 지도 중심좌표에 마커를 생성합니다
					position: map.getCenter()
				});
				 // 지도에 마커를 표시합니다
				marker.setMap(map);

				var latitude = document.createElement('input');
				var longitude = document.createElement('input');

				latitude.setAttribute('type', 'hidden');
				latitude.setAttribute('name', 'bbscttCchLa');
				latitude.setAttribute('value', lat);

				longitude.setAttribute('type', 'hidden');
				longitude.setAttribute('name', 'bbscttCchLo');
				longitude.setAttribute('value', lng);

				mapContainer.appendChild(latitude);
				mapContainer.appendChild(longitude);
			}
			/* 지도 관련 */


			/*[- end of function -]*/

			/*]]>*/
		</script>
	</th:block>
</html>